{% extends "frontend/base.html" %}
{% block content %}

    <div class="container-fluid border p-5 w-25" >
        <form>
            <fieldset class="form-group">
                <legend class="border-bottom mb-4 text-center">Sign Up</legend>
        
            <div class="row">
                Username: <input id="username" type="text" value="" />
            </div>
            <div class="row">
                Email: <input id="email" type="email" ></input>
            </div>
            <div class="row">
                Password: <input type="password" id="password1" ></input>
            </div>
            <div class="row">
                Confirm Password: <input type="password" id="password2" ></input>
            </div>

            <div id="container" class='container-fluid'>
            </div>

            </fieldset>
            <div class="form-group text-center">
                <button class="btn btn-outline-info m-3" onclick="register(event)" >Sign Up</button>
            </div> 
        </form>

        <div class="border-top pt-3">
            <small class="text-muted">
            Already have an account? <a class="ml-2" href="login">login</a>
            </small>
        </div>
    </div>


    <script type="text/javascript">
          // prevent the page from going backwards
        function preback(){
            window.history.forward(); 
        }
        setTimeout("preback()",0);
        window.onunload = function(){null};

        // Post the data and get the response from API
        function register(e){
            e.preventDefault()
            document.getElementById('container').innerHTML = ''
            
            var uname = document.getElementById('username').value
            var e = document.getElementById('email').value
            var p1 = document.getElementById('password1').value
            var p2 = document.getElementById('password2').value
            
            var data = {
                username: uname,
                email: e,
                password1: p1,
                password2: p2,
            }
            var options = {
                method: "POST",
                body: JSON.stringify(data),
                headers: {
                    "Content-Type": "application/json"
                    }
                }
            console.log('test1')
            fetch("http://127.0.0.1:8000/api/register/", options)
                .then((response) => {
                    console.log(response)
                    if (! response.ok){
                        throw Error('Error')
                    }
                    return response.json()
                })
                .then((json_data) => {
                    if (json_data.response != 'Success'){
                        var html = `<div class="row my-3">`
                        for(const key in json_data){
                            html += `
                                <p class='text-danger'>${key}: ${json_data[key]}</p>
                            `
                        }
                        html+= '</div>'
                        document.querySelector("#container").insertAdjacentHTML('afterbegin', html)
                    }
                    else{
                        sessionStorage.setItem("username", json_data.username)
                        sessionStorage.setItem("email", json_data.email)
                        sessionStorage.setItem("password", json_data.password)
                        window.location.replace("http://127.0.0.1:8000/frontend/otpverification")
                    }
                })
                .catch( error => {
                    console.log(error)
                })
            }

    </script>

{% endblock content %}