{% extends "frontend/base.html" %}
{% load index %}
{% block content %}

<!-- Profile Page which shows the completed Quizzes of the user -->

    <div id="container" class="container">
    </div>


    
    <div id="container1" class="container">
    </div>

    <script type="text/javascript">

    window.onload = function(){

        var url = 'http://127.0.0.1:8000/api/profile'
        var token = sessionStorage.getItem("token")
        console.log(token)
        {% comment %} if (token==null){
            top.location.href="http://127.0.0.1:8000/frontend/login"
        } {% endcomment %}
        var options = {
            method: "GET", 
            headers:{
                "Content-Type": "application/json",
                Authorization: "token 88a811f4fe0e031dbf7c8f865568df13cb8feb19"
            }
        }
        fetch(url,options).then((response) => {
            console.log(response)
            if (!response.ok){
                throw Error('Error')
            }
            return response.json()
        })
        .then((json_data) => {
            const data = json_data['results'].map(quiz => {
                return `
                    <div class="row border m-2">
                        <div class="row m-2 p-1">
                            <h4>${quiz.quiz_name}</h4>
                        </div>
                        <div class="row m-2 p-1">
                            <h5>${quiz.quiz_desc}</h5>
                        </div>
                        <div class="row m-2 p-1">
                            <form>
                                <input type="hidden" id="quiz_id" value="${quiz.quiz_id}"/>
                                <!-- Button which redirects to the Results page to show the details of the taken Quiz-->
                                <button id="show_details" class="btn btn-primary" onclick="get_results()" > Show Details </button>
                            </form>
                        </div> 
                    </div>
                `
            }).join("")


            document.querySelector("#container").insertAdjacentHTML('afterbegin', data)
            
            
        })
        .catch( error => {
            console.log(error)
        })
    }

    
    function get_results(){
        var quiz_id = document.getElementById('quiz_id').value
        var url = 'http://127.0.0.1:8000/api/profile/'
        var token = sessionStorage.getItem("token")
        {% comment %} if (token==null){
            top.location.href="http://127.0.0.1:8000/frontend/login"
        } {% endcomment %}

        var data = {
            quiz_id:quiz_id
        }
        var options = {
            method: "POST", 
            body: JSON.stringify(data),
            headers:{
                "Content-Type": "application/json;charset=UTF-8",
                Authorization: "token 88a811f4fe0e031dbf7c8f865568df13cb8feb19"
            }
        }

        fetch(url,options).then((response) => {
            if (!response.ok){
                throw Error('Error')
            }
            
            document.getElementById('container').style.display = "none"
            return response.json()
        })
        .then((json_data) => {
            console.log(json_data.UsersAnswer[0])
            var data = `
                    <div class="row">
                        <div class="col border p-2">
                            <h4> Question </h4>
                        </div>
                        <div class="col border p-2">
                            <h4> Your answer </h4>
                        </div>
                        <div class="col border p-2">
                            <h4> Correct answer </h4>
                        </div>
                    </div>
                `
                for (i=0; i<json_data.questions.length; i++){
                    `
                    <div class="row p-2">
                        <div class="col">
                            <h5>${json_data.questions[i].question}</h5>
                        </div>
                        <div class="col">
                            <h5>${json_data.UsersAnswer[i]}</h5>
                        </div>
                        <div class="col">
                            <h5>${json_data.correct_answer[i]}</h5>
                        </div>
                    </div>
                    `
                }
                `<div class='row border'></div>

                <div class="row m-2 p-1">
                    <div class="col">
                        <h4> Total Marks: ${json_data.total_marks}</h4>
                    </div>
                </div>
                <div class="row m-2 p-1">
                    <div class="col">
                        <h4> Marks Obtained: ${json_data.marks_obtained}</h4>
                    </div>
                </div>
                <div class="row m-2 p-1">
                    <div class="col">
                        <h4> Percentage: ${json_data.perct} % </h4>
                    </div>
                </div>
        
            `

            document.querySelector("#container1").insertAdjacentHTML('afterbegin', data)
            
        })
        .catch( error => {
            console.log(error)
        })
    }


    </script>

{% endblock content %}

